\documentclass{article}

\usepackage{subfiles}
\usepackage[a4paper,hmargin=3.4cm]{geometry}
\usepackage{subcaption}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{hyperref,cleveref}
\usepackage{dsfont,mathrsfs}
\usepackage[
linesnumbered,lined,boxed
]{algorithm2e}

\usepackage[dvipsnames]{xcolor}
\usepackage{amsthm}

\usepackage{graphicx}

\usepackage{csquotes}
\usepackage[
backend=biber
]{biblatex}

\addbibresource{../bibliography/references.bib}

%% Hyperref %%

\hypersetup{
colorlinks,
citecolor=Green
}

\crefalias{prop}{proposition}

%%% DEFINE MACROS %%%

%% Math %%

\newcommand{\RR}{\mathbb{R}}
\newcommand{\TT}{\mathbb{T}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\BB}{\mathbb{B}}
\newcommand{\WW}{\mathbb{W}}

\newcommand{\calC}{\mathcal{C}}
\newcommand{\calI}{\mathcal{I}}
\newcommand{\calK}{\mathcal{K}}
\newcommand{\calP}{\mathcal{P}}
\newcommand{\calT}{\mathcal{T}}
\newcommand{\calS}{\mathcal{S}}
\newcommand{\calM}{\mathcal{M}}
\newcommand{\calW}{\mathcal{W}}
\newcommand{\calX}{\mathcal{X}}

\newcommand{\suchthat}{\mathrm{s.t.}}

\renewcommand{\phi}{\varphi}
\renewcommand{\epsilon}{\varepsilon}

\DeclareMathOperator{\divg}{div}
\DeclareMathOperator{\Ent}{Ent}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}

\DeclareMathOperator{\KL}{KL}
\DeclareMathOperator{\prox}{prox}

\numberwithin{equation}{section}

%% THEOREM ENVS %%

\newtheorem{prop}{Proposition}
\newtheorem{thmalgo}{Algorithm}
\theoremstyle{definition}
\newtheorem{remark}{Remark}

\author{Wilson \textsc{Jallet}}
\title{
{\large\textit{Computational Optimal Transport} -- \textsf{Project report:}}\\
Regularized Optimal Transport methods for solving variational Mean-Field Games}

\begin{document}
\maketitle


\section{General setting: variational mean-field games}

A mean-field game \cite{LASRY2006619,LASRY2006679} is a strategic decision-making problem with a very large, continuously-distributed number of interacting agents inside a state space: the overall theory developed by \citeauthor{LASRY2006619} can be used as a means to model large, computationally intractable games. In the continuous-time setting explored in \cite{LASRY2006679}, each agent evolves according to some dynamics -- leading to a so-called \textit{differential game} -- with the response to his choices depends on other agents' states and actions through a \textit{mean-field} effect.


The general setup of a MFG has every agent penalize a running cost on the control and mean-field interaction, as well as a terminal cost on the its final position and the overall final distribution of agents (see \cite{LASRY2006679}). The framework of \cites{benamou:hal-01295299}{benamou2018entropy} focuses on games with agent dynamics $dX_t = \alpha_tdt + dW_t$ where the running cost of the control $\alpha$ is a quadratic function.

The (Nash) equilibrium agent-control dynamics can be summarized by the system of coupled nonlinear partial differential equations:
\begin{subequations}\label{eq:VariationalQuadraticMFG}
\begin{align}\label{eq:VarQuadMFGHJB}
	-\partial_t u - \frac{1}{2}\Delta u + \frac12|\nabla u|^2 &= f[\rho_t] \quad (t,x) \in  (0, T) \times \Omega \\\label{eq:VarQuadMFGKolmo}
	\partial_t \rho_t - \frac{1}{2}\Delta\rho_t - \divg(\rho_t \nabla u) &= 0 \\
	\rho_0 &\text{ given} \\
	u(T, \cdot) &= g[\rho_T]
\end{align}
\end{subequations}
where and $t\mapsto \rho_t$ is a trajectory in the space of measures, and $\Omega$ a subset of the Euclidean space $\RR^d$. The applications $f[\mu]$ and $g[\mu]$ are supposed to be derivatives of some real-valued functionals $F$ and $G$ on the space of measures. For instance, if $G(\mu) = \int_\Omega \Psi\,d\mu(x)$ then its derivative is $g[\mu](x) = \Psi(x)$.

\Cref{eq:VarQuadMFGHJB,eq:VarQuadMFGKolmo} form a coupled system of control (Hamilton-Jacobi-Bellman) and diffusion (Fokker-Planck) partial differential equations. They can be solved in some cases using finite-difference methods (see \textcite{achdou:hal-01456506}).

\section{Variational formulations for the quadratic MFG}

The first idea of \cite{benamou:hal-01295299} is to cast the MFG partial differential equations to a variational problem over an appropriate function space. Denote $\WW_2(\Omega) = (\calP_2(\Omega), \calW_2)$ the set of probability measures with finite second moment, equipped with the Wasserstein metric
\begin{equation}\label{eq:Wasserstein2Metric}
   	\calW_2(\mu,\nu)^2 = \inf_{\gamma\in\Pi(\mu,\nu)}
   	\int {|x-y|}^2 d\gamma
\end{equation}
where $\Pi(\mu,\nu) =\{ \gamma \in \calP_2(\Omega\times\Omega) : P^1_{\#}\gamma = \mu,\; P^2_{\#}\gamma = \nu \}$ is the set of transport plants from $\mu$ to $\nu$.
Then, $\mathcal{C}([0, T], \WW_2(\Omega))$ is the Wiener space of continuous $\WW_2$-valued trajectories.
\textcite{benamou:hal-01295299} show that the MFG be reformulated to the following variational problem:
\begin{equation}\label{eq:EulerianProblem}
\begin{aligned}
   	&\inf_{\rho,v} J(\rho, v) =
   	\frac{1}{2}\int_0^T\int_\Omega |v_t|^2 \,d\rho_t(x)\,dt + \int_0^T F(\rho_t)\,dt + G(\rho_T)
   	\\
   	\suchthat\ &\partial_t \rho_t - \frac12\Delta \rho_t + \divg(\rho_t v) = 0 \\
   	&\rho_0 \in \WW_2(\Omega)	
\end{aligned}
\end{equation}
where $\rho = (\rho_t)_{t\in[0,T]}\in \calC([0,T], \WW_2(\Omega))$ is a trajectory in $\WW_2$ and $v$ is a sufficiently regular function on $[0,T] \times \Omega$, most likely lying in a Sobolev space -- see \cite{benamou:hal-01295299} for further discussion on regularity.

This point of view \cite{benamou:hal-01295299} is called \textit{Eulerian}: we minimize over both the velocity $v$ and the time-trajectory of the agents' density $\rho$. This can be solved by introducing Lagrange multipliers, exploiting duality, and using a finite element method, as shown in \cite{benamou:hal-01295299}.

\textcite{benamou:hal-01295299,benamou2018entropy} also introduce a \textit{Lagrangian} point of view, which allows to use tools from optimal transport theory: the variational problem is changed to optimize over the space of probability distributions on the space of agent trajectories.


\subsection{Lagrangian formulation}

\subsubsection{Wiener space and measure}

This new point of view involves a change in function spaces. We denote $\calX = \calC([0,T], \Omega)$ the Wiener space of (agents') trajectories $[0,T] \rightarrow\Omega$. Following \cites{benamou:hal-01295299,benamou2015lagrangian}, we equip it with the Wiener measure (the law of a Wiener process with any starting point $x$)
\[
   	R = \int_\Omega \delta_{x + W}\,dx
\]
  	where $W$ is a standard Wiener process in $\RR^d$. It is an analogue in the space $\calX$ to the usual finite-dimensional Lebesgue measure\footnote{\url{https://en.wikipedia.org/wiki/Infinite-dimensional_Lebesgue_measure}}.
  	
  	Measures $Q \in \calP(\calX)$ can also be seen as trajectories $(Q_t)_{t\in[0,T]} \in \calC([0,T], \calP(\Omega))$, with
\[
   	Q_t = e_{t\#}Q \in \calP(\Omega)
\]
the push-forward of $Q$ by the evaluation map $e_t\colon \xi\in\calX\longmapsto \xi(t)$. This naturally defines an injection $\underline{i} \colon \calP(\calX) \rightarrow \calC([0,T], \calP(\Omega))$. We also introduce the more general marginals $Q_{t_1,\ldots,t_n} = (e_{t_1},\ldots, e_{t_n})_\# Q$ for $0\leq t_1 < \cdots < t_N \leq T$.

\paragraph{Marginals of the Wiener measure $\boldsymbol{R}$.} In particular, $R_t$ is the Lebesgue measure $\mathcal{L}^d$ on $\RR^d$, and
\begin{equation}\label{eq:2MarginWienerMeasure}
   	R_{s,t}(dx,dy) = G_{t-s}(x-y)\,dx\,dy.
\end{equation}
Where $G_t$ is the standard heat kernel
\[
	G_t(u) =
	\frac{1}{(2\pi t)^{d/2}} \exp\left(-\frac{|u|^2}{2t}\right)
\]

\textcite{benamou:hal-01295299,benamou2015lagrangian} then re-cast the Eulerian variational game \eqref{eq:EulerianProblem} into a Lagrangian optimization problem over the set of Borel probability measures. This new problem is also solved in \cite{benamou:hal-01295299} using a finite element method, which is computationally expensive.




\subsubsection{Entropic Lagrangian}

Instead, \textcite{benamou2018entropy} propose using an entropy minimization approach to allow for a more computationally efficient method adapted from the Sinkhorn algorithm introduced by \textcite{cuturi2013sinkhorn}.

This method, just like the Sinkhorn for OT between histograms (discrete measures), introduces some sort of entropic regularization \cite{benamou2018entropy}, but this time on the measure over the trajectory space $\calX$. The resulting numerical algorithm becomes a regularization of the Lagrangian from \cite{benamou:hal-01295299,benamou2015lagrangian}.

The entropic Lagrangian variational problem is
\begin{equation}\label{eq:EntropyLagrangianProblem}
\inf_{Q\in\calP(\calX)}
H(Q|R) + \int_0^T F(Q_t)\,dt + G(Q_T) \quad
\suchthat\ Q_0 = \rho_0
\end{equation}

Intuitively, this is the same as fixing the marginals $\rho_t$, finding the optimal bridge $Q$ between them that has minimal entropy relative to the Wiener measure, and then optimizing over the $\rho_t$.


\subsection{Viscosity and the deterministic limit}

We change the MFG problem to one following the agent-level dynamics $dX_t = \alpha_t dt + {\color{Brown}\sigma} dW_t$ with a diffusion coefficient $\sigma$. The MFG equilibrium equations become
\begin{equation}
\begin{aligned}
	-\partial_t u - \frac{\color{Brown}\sigma^2}{2}\Delta u + \frac12 |\nabla u|^2 &= f[\rho_t] \\
	\partial_t \rho - \frac{\color{Brown}\sigma^2}{2}\Delta\rho - \divg(\rho\nabla u) &= 0
\end{aligned}	
\end{equation}
This can be used to approximate first-order MFGs by setting a low viscosity parameter $\sigma$.
Denoting $\color{Brown}\epsilon = \sigma^2$, the entropic variational problem \eqref{eq:EntropyLagrangianProblem} becomes
\[
	\inf_{Q\in\calP(\calX)}
	{\color{Brown}\epsilon} H(Q|{\color{Brown}R_{\epsilon}}) + \int_0^T F(Q_t)\,dt + G(Q_T)\quad
	\suchthat\ Q_0 = \rho_0
\]
where $\color{Brown}R_{\epsilon}$ is the Wiener measure associated with Wiener processes scaled by $\color{Brown}\epsilon$.

\section{Numerical algorithm}

\subfile{parts/algo.tex}



\section{Examples}

\subfile{parts/examples.tex}




\printbibliography{}







\end{document}
